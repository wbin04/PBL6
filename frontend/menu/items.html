<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥n ƒÉn - FastFood App</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="../index.html" class="logo">üçî FastFood</a>
            
            <nav class="nav">
                <a href="../index.html">Trang ch·ªß</a>
                <a href="categories.html">Th·ª±c ƒë∆°n</a>
                
                <div id="guest-menu" class="hidden">
                    <a href="../auth/login.html">ƒêƒÉng nh·∫≠p</a>
                    <a href="../auth/register.html">ƒêƒÉng k√Ω</a>
                </div>
                
                <div id="user-menu" class="hidden">
                    <a href="../cart/cart.html" class="cart-link">
                        üõí Gi·ªè h√†ng
                        <span id="cart-count" class="cart-count">0</span>
                    </a>
                    <a href="../orders/orders.html">ƒê∆°n h√†ng</a>
                    <span>Xin ch√†o, <span id="user-name"></span></span>
                    <a href="#" onclick="logout()">ƒêƒÉng xu·∫•t</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div style="margin: 2rem 0;">
                <a href="categories.html">‚Üê Quay l·∫°i danh m·ª•c</a>
                <h2 style="margin: 1rem 0;">M√≥n ƒÉn</h2>
            </div>
            
            <!-- Search & Filter -->
            <div class="card" style="margin-bottom: 2rem;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="search-input" placeholder="T√¨m ki·∫øm m√≥n ƒÉn..." 
                           style="flex: 1; min-width: 200px;" onkeyup="handleSearch(event)">
                    <select id="category-filter" onchange="filterByCategory()">
                        <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                    </select>
                    <select id="sort-filter" onchange="sortFoods()">
                        <option value="created_date">M·ªõi nh·∫•t</option>
                        <option value="price_asc">Gi√° tƒÉng d·∫ßn</option>
                        <option value="price_desc">Gi√° gi·∫£m d·∫ßn</option>
                        <option value="name">T√™n A-Z</option>
                    </select>
                    <button class="btn btn-primary" onclick="searchFoods()">T√¨m ki·∫øm</button>
                </div>
            </div>
            
            <div id="foods-container">
                <div id="foods-grid" class="grid foods-grid">
                    <!-- Foods will be loaded here -->
                </div>
            </div>
            
            <div id="pagination" class="pagination">
                <!-- Pagination will be loaded here -->
            </div>
        </div>
    </main>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/cart.js"></script>
    <script src="../assets/js/app.js"></script>
    <!-- Ratings Modal -->
    <div id="rating-modal-overlay" class="modal-overlay hidden">
        <div class="modal">
            <button id="rating-modal-close" class="modal-close">&times;</button>
            <h3>ƒê√°nh gi√°</h3>
            <div id="rating-modal-content" class="rating-details"></div>
        </div>
    </div>
    <script>
        let currentPage = 1;
        let currentCategory = '';
        let currentSearch = '';
        let currentSort = 'created_date';

        async function loadCategories() {
            try {
                const categories = await API.get('/menu/categories/');
                const select = document.getElementById('category-filter');
                
                // Clear existing options (except "T·∫•t c·∫£ danh m·ª•c")
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.cate_name;
                    select.appendChild(option);
                });
                
                // Check URL params for category and set it
                const urlParams = new URLSearchParams(window.location.search);
                const categoryId = urlParams.get('category');
                if (categoryId) {
                    select.value = categoryId;
                    currentCategory = categoryId;
                    
                    // Update page title to show category name
                    const selectedCategory = categories.find(cat => cat.id == categoryId);
                    if (selectedCategory) {
                        document.querySelector('h2').textContent = `M√≥n ƒÉn - ${selectedCategory.cate_name}`;
                    }
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadFoods(page = 1) {
            try {
                showLoading('foods-container');
                
                const params = new URLSearchParams();
                if (currentCategory) params.append('category', currentCategory);
                if (currentSearch) params.append('search', currentSearch);
                if (currentSort) params.append('sort', currentSort);
                params.append('page', page.toString());

                const response = await API.get(`/menu/items/?${params.toString()}`);
                
                hideLoading('foods-container');
                displayFoods(response.results);
                updatePagination(response.count, page);
                
            } catch (error) {
                console.error('Error loading foods:', error);
                const container = document.getElementById('foods-container');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>Kh√¥ng th·ªÉ t·∫£i m√≥n ƒÉn</h3>
                            <p>Vui l√≤ng th·ª≠ l·∫°i sau. L·ªói: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        function displayFoods(foods) {
            const container = document.getElementById('foods-grid');
            
            if (!container) {
                console.error('foods-grid element not found');
                return;
            }
            
            if (!foods || foods.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn n√†o</h3>
                        <p>Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c t·ª´ kh√≥a t√¨m ki·∫øm</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = foods.map(food => {
                const isAvailable = food.availability === 'C√≤n h√†ng';
                const availabilityClass = isAvailable ? 'available' : 'unavailable';

                return `
                    <div class="food-card" data-food-id="${food.id}">
                        <img src="${getImageUrl(food.image)}" alt="${food.title}">
                        <div class="food-info">
                            <h3>${food.title}</h3>
                            <p class="description">${food.description}</p>
                            <div class="food-rating clickable" onclick="toggleRatings(${food.id})">
                                <span class="stars">${'‚òÖ'.repeat(Math.floor(food.average_rating || 0))}${'‚òÜ'.repeat(5 - Math.floor(food.average_rating || 0))}</span>
                                <span>(${food.rating_count} ƒë√°nh gi√°)</span>
                            </div>
                            <div class="rating-details" id="ratings-${food.id}" style="display:none;"></div>
                            <div class="availability-status ${availabilityClass}">${food.availability}</div>
                            <div class="price">${formatPrice(food.price)}</div>
                            <button class="btn btn-primary" onclick="addToCart(${food.id}, '${food.title}', ${food.price})" ${!isAvailable ? 'disabled' : ''}>
                                ${isAvailable ? 'Th√™m v√†o gi·ªè' : 'T·∫°m h·∫øt h√†ng'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function handleSearch(event) {
            if (event.key === 'Enter') {
                searchFoods();
            }
        }

        function searchFoods() {
            currentSearch = document.getElementById('search-input').value;
            currentPage = 1;
            loadFoods(currentPage);
        }

        function filterByCategory() {
            currentCategory = document.getElementById('category-filter').value;
            currentPage = 1;
            // Update URL with selected category and reset page
            const params = new URLSearchParams(window.location.search);
            if (currentCategory) {
                params.set('category', currentCategory);
            } else {
                params.delete('category');
            }
            params.set('page', currentPage);
            window.history.replaceState(null, '', `${window.location.pathname}?${params.toString()}`);
            loadFoods(currentPage);
        }

        function sortFoods() {
            currentSort = document.getElementById('sort-filter').value;
            currentPage = 1;
            loadFoods(currentPage);
        }

        function updatePagination(totalCount, currentPageNum) {
            const itemsPerPage = 12;
            const totalPages = Math.ceil(totalCount / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            if (currentPageNum > 1) {
                paginationHTML += `<button onclick="loadFoods(${currentPageNum - 1})">Tr∆∞·ªõc</button>`;
            }
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPageNum) {
                    paginationHTML += `<button class="active">${i}</button>`;
                } else {
                    paginationHTML += `<button onclick="loadFoods(${i})">${i}</button>`;
                }
            }
            
            if (currentPageNum < totalPages) {
                paginationHTML += `<button onclick="loadFoods(${currentPageNum + 1})">Sau</button>`;
            }
            
            pagination.innerHTML = paginationHTML;
            currentPage = currentPageNum;
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                // Don't replace innerHTML, just add loading indicator
                let loadingDiv = element.querySelector('.loading');
                if (!loadingDiv) {
                    loadingDiv = document.createElement('div');
                    loadingDiv.className = 'loading';
                    loadingDiv.textContent = 'ƒêang t·∫£i...';
                    element.appendChild(loadingDiv);
                }
            }
        }

        function hideLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                const loading = element.querySelector('.loading');
                if (loading) {
                    loading.remove();
                }
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            updateAuthUI();
            await loadCategories(); // Wait for categories to load first
            loadFoods(); // Then load foods with correct category filter
            updateCartCount();
        });
    </script>
</body>
</html>

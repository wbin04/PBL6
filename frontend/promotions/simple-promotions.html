<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khuy·∫øn m√£i - FastFood App</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="promotions.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <a href="../index.html" class="logo">üçî FastFood</a>
            
            <nav class="nav">
                <a href="../index.html">Trang ch·ªß</a>
                <a href="../menu/categories.html">Th·ª±c ƒë∆°n</a>
                <a href="promotions.html" class="active">Khuy·∫øn m√£i</a>
                
                <div id="guest-menu" class="hidden">
                    <a href="../auth/login.html">ƒêƒÉng nh·∫≠p</a>
                    <a href="../auth/register.html">ƒêƒÉng k√Ω</a>
                </div>
                
                <div id="user-menu" class="hidden">
                    <a href="../cart/cart.html" class="cart-link">
                        üõí Gi·ªè h√†ng
                        <span id="cart-count" class="cart-count">0</span>
                    </a>
                    <a href="../orders/orders.html">ƒê∆°n h√†ng</a>
                    <a href="../admin/admin.html" id="admin-link" class="hidden">Admin</a>
                    <a href="../auth/account.html" class="account-link">Xin ch√†o, <span id="user-name"></span></a>
                    <a href="#" onclick="logout()">ƒêƒÉng xu·∫•t</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <div class="page-header">
                <h1>üéâ Khuy·∫øn m√£i ƒë·∫∑c bi·ªát</h1>
                <p>Kh√°m ph√° nh·ªØng ∆∞u ƒë√£i h·∫•p d·∫´n t·ª´ c√°c c·ª≠a h√†ng</p>
            </div>

            <!-- Store Filter -->
            <div class="filters-section">
                <div class="filter-group">
                    <label for="store-filter">Ch·ªçn c·ª≠a h√†ng:</label>
                    <select id="store-filter" onchange="filterPromotionsByStore()">
                        <option value="">T·∫•t c·∫£ c·ª≠a h√†ng</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="promo-type-filter">Lo·∫°i khuy·∫øn m√£i:</label>
                    <select id="promo-type-filter" onchange="filterPromotionsByType()">
                        <option value="">T·∫•t c·∫£ lo·∫°i</option>
                        <option value="PERCENT">Gi·∫£m theo ph·∫ßn trƒÉm</option>
                        <option value="AMOUNT">Gi·∫£m s·ªë ti·ªÅn</option>
                    </select>
                </div>
            </div>

            <!-- Promotions Grid -->
            <div class="promotions-container">
                <div id="promotions-grid" class="promotions-grid">
                    <!-- Promotions will be loaded here -->
                </div>
                
                <div id="no-promotions" class="no-promotions hidden">
                    <div class="empty-state">
                        <h3>Kh√¥ng c√≥ khuy·∫øn m√£i n√†o</h3>
                        <p>Hi·ªán t·∫°i kh√¥ng c√≥ khuy·∫øn m√£i ph√π h·ª£p v·ªõi b·ªô l·ªçc c·ªßa b·∫°n.</p>
                    </div>
                </div>
                
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i khuy·∫øn m√£i...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../assets/js/api.js"></script>
    <script>
        // Simple version without dependencies
        let allPromotions = [];
        let allStores = [];
        
        // Simple auth UI update
        function updateAuthUI() {
            console.log('Simple auth UI update');
        }
        
        // Simple cart count update
        function updateCartCount() {
            console.log('Simple cart count update');
        }
        
        // Simple logout function
        function logout() {
            console.log('Simple logout');
        }
        
        async function loadData() {
            try {
                console.log('Loading data...');
                
                // Load stores
                const stores = await API.get('/stores/');
                allStores = stores;
                
                const storeFilter = document.getElementById('store-filter');
                stores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store.id;
                    option.textContent = store.store_name;
                    storeFilter.appendChild(option);
                });
                
                // Load promotions
                const promotions = await API.get('/promotions/');
                allPromotions = promotions;
                
                displayPromotions(promotions);
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('promotions-grid').innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: red;">L·ªói: ' + error.message + '</div>';
            }
        }
        
        function displayPromotions(promotions) {
            const grid = document.getElementById('promotions-grid');
            const loading = document.getElementById('loading');
            const noPromotions = document.getElementById('no-promotions');
            
            loading.classList.add('hidden');
            
            if (promotions.length === 0) {
                grid.innerHTML = '';
                noPromotions.classList.remove('hidden');
                return;
            }
            
            noPromotions.classList.add('hidden');
            
            grid.innerHTML = promotions.map(promo => {
                const store = allStores.find(s => s.id === promo.store_id);
                const storeName = store ? store.store_name : 'C·ª≠a h√†ng';
                
                return `
                    <div class="promotion-card">
                        <div class="promotion-header">
                            <div class="promotion-badge">${promo.category === 'PERCENT' ? 'Gi·∫£m %' : 'Gi·∫£m ti·ªÅn'}</div>
                            <h3 class="promotion-title">${promo.name}</h3>
                        </div>
                        <div class="promotion-body">
                            <div class="promotion-discount">
                                <span class="discount-value">${promo.category === 'PERCENT' ? promo.discount_value + '%' : formatCurrency(promo.discount_value)}</span>
                                <span class="discount-type">${promo.category === 'PERCENT' ? 'Gi·∫£m gi√°' : 'Gi·∫£m ti·ªÅn'}</span>
                            </div>
                            <div class="promotion-details">
                                <div class="detail-row">
                                    <span class="detail-label">ƒê∆°n t·ªëi thi·ªÉu:</span>
                                    <span class="detail-value">${formatCurrency(promo.minimum_pay)}</span>
                                </div>
                                ${promo.max_discount_amount ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Gi·∫£m t·ªëi ƒëa:</span>
                                        <span class="detail-value">${formatCurrency(promo.max_discount_amount)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="promotion-footer">
                            <span class="promotion-store">üìç ${storeName}</span>
                            <span class="promotion-status status-active">ƒêang ho·∫°t ƒë·ªông</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
        
        function filterPromotionsByStore() {
            const storeId = document.getElementById('store-filter').value;
            const typeFilter = document.getElementById('promo-type-filter').value;
            
            let filtered = allPromotions.filter(promo => {
                if (storeId && promo.store_id.toString() !== storeId) return false;
                if (typeFilter && promo.category !== typeFilter) return false;
                return true;
            });
            
            displayPromotions(filtered);
        }
        
        function filterPromotionsByType() {
            filterPromotionsByStore(); // Reuse the same logic
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            updateAuthUI();
            updateCartCount();
            loadData();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PayOS Checkout</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
        }

        input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Thanh toán qua PayOS</h1>
        <label for="user_id">User ID:</label>
        <input type="text" id="user_id" value="1" required />
        <label for="order_id">Order ID:</label>
        <input type="text" id="order_id" value="1" required />
        <label for="amount">Số tiền (VNĐ):</label>
        <input type="number" id="amount" value="2000" min="1000" required />
        <label for="message">Nội dung chuyển khoản:</label>
        <input type="text" id="message" placeholder="Nội dung" readonly />
        <button id="submit">Thanh toán</button>
    </div>

    <script>
        const TARGET_ORIGIN = window.location.origin;
        let payPopup = null;

        (function () {
            const params = new URLSearchParams(location.search);
            const orderCode = params.get('orderCode') || '';
            const payosStatus = params.get('payos');
            const status = payosStatus === 'success' ? 'success' : 'cancel';
            try {
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage(
                        { type: 'PAYOS_RESULT', status, orderCode },
                        window.location.origin
                    );
                }
            } catch (e) {
                console.error(e);
            }
            setTimeout(() => {
                window.close();
            }, 500);
        })();

        window.addEventListener('message', (event) => {
            if (event.origin !== TARGET_ORIGIN) return;
            const data = event.data || {};
            if (data.type !== 'PAYOS_RESULT') return;
            try { if (payPopup && !payPopup.closed) payPopup.close(); } catch { }
            requestAnimationFrame(() => {
                try { window.focus(); } catch { }
                const msg = data.status === 'success'
                    ? 'Thanh toán thành công'
                    : 'Đã huỷ thanh toán';
                alert(msg);
                window.location.replace(
                    `/checkout.html?orderCode=${encodeURIComponent(data.orderCode || '')}`
                );
            });
        });

        document.getElementById('submit').addEventListener('click', async () => {
            const user_id = document.getElementById('user_id').value.trim();
            const order_id = document.getElementById('order_id').value.trim();
            const amount = Number(document.getElementById('amount').value);
            const message = `${user_id} TTDH ${order_id}`;
            document.getElementById('message').value = message;
            if (!order_id || !(amount > 0)) {
                alert('Vui lòng nhập order_id và số tiền hợp lệ');
                return;
            }
            payPopup = window.open('about:blank', '_blank');
            if (!payPopup) {
                alert('Trình duyệt đã chặn popup. Hãy cho phép mở popup cho trang này.');
                return;
            }
            payPopup.document.write('<p>Đang tạo liên kết thanh toán...</p>');
            try {
                const res = await fetch('/create_payment_link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id, order_id, amount, message })
                });
                const data = await res.json();
                if (res.ok && data.checkoutUrl) {
                    payPopup.location = data.checkoutUrl;
                } else {
                    payPopup.close();
                    alert(data.error || 'Không tạo được link thanh toán');
                    console.log('Server response:', data);
                }
            } catch (err) {
                try { payPopup.close(); } catch { }
                alert('Lỗi mạng hoặc server.');
                console.error(err);
            }
        });
    </script>
</body>

</html>